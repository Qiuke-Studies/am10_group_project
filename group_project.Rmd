---
title: "Data Visualisation Group Project"
author: "Lucia Cai, Neha Dagade, Piotr Rudniak, Gian Marco Serra, Mingqi Yin"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: flatly
    highlight: zenburn
    number_sections: true
    toc: yes
    toc_float: yes
---

```{r, setup, include = FALSE}
knitr::opts_chunk$set(
  message = FALSE, 
  warning = FALSE, 
  tidy = FALSE,     # display code as typed
  size = "small")   # slightly smaller font for code
options(digits = 3)

# default figure size
knitr::opts_chunk$set(
  fig.width = 6.75, 
  fig.height = 6.75,
  fig.align = "center"
)
```

```{r libraries, include=FALSE}
library(tidyverse)
library(extrafont)
library(vroom)
library(ggtext)
library(gapminder)
library(ggrepel)
library(patchwork)
library(gghighlight)
library(skimr)
library(remotes)
library(here)
library(nycdogs)
library(sf) # for geospatial visualisation
library(readr)
library(lubridate)

loadfonts(device="pdf")

```


# Loading and cleaning data

```{r}

# Adjust data location as file is to large for github
data <- read_csv("/Users/prudn/OneDrive/Pulpit/train.csv.zip") %>% 
  janitor::clean_names()

glimpse(data)

# Mutate dates
data <- data %>% 
  mutate(year = year(dates),
         month = month(dates),
         day = day(dates),
         hour = hour(dates))

# Count number of crimes
data_all <- data %>% 
  group_by(year, month, day, hour, day_of_week, category, pd_district, resolution) %>% 
  count(year)
  
```


```{r, resolution visualization}

ggplot(data = data_all, aes(x = resolution)) +
  geom_bar(stat = "count")

# mutate resolution
data_all <- data_all %>% 
  mutate(resolution = ifelse(resolution == "ARREST, BOOKED" | resolution == "ARREST, CITED", "ARREST", resolution),
         resolution = ifelse(resolution == "ARREST" | resolution == "NONE", resolution, "OTHER"))

ggplot(data = data_all, aes(x = resolution)) +
  geom_bar(stat = "count")



```

```{r, count by category}

ggplot(data = data_all, aes(x = category)) +
  geom_bar(stat = "count")

data_all %>% 
  group_by(category) %>% 
  count(category) %>% 
  arrange(desc(n))


# change categories?

```
 

```{r, load unemployment}
# https://fred.stlouisfed.org/series/CASANF0URN 

unemployment <- read_csv("data/unemployment.csv") %>% 
  janitor::clean_names()


unemployment <- unemployment %>% 
  pivot_longer(!year, names_to = "month", values_to = "unemployment") %>% 
  mutate(monthyear = as.Date(paste(year, month, "01"), format = "%Y %b %d"),
         month = month(monthyear)) %>% 
  select(year, month, unemployment)
```


```{r, load CPI}
# https://fred.stlouisfed.org/series/CUURA422SA0

cpi <- read_csv("data/cpi.csv") %>% 
  janitor::clean_names()

glimpse(cpi)

cpi <- cpi %>% 
  pivot_longer(!year, names_to = "month", values_to = "cpi") %>% 
  mutate(monthyear = as.Date(paste(year, month, "01"), format = "%Y %b %d"),
         month = month(monthyear)) %>% 
  select(year, month, cpi)


```



```{r, load population}

# population https://fred.stlouisfed.org/series/CASANF0POP
pop <- read_csv("data/population.csv") %>% 
  janitor::clean_names()

glimpse(pop)



pop <- pop %>% 
  mutate(date = as.Date(date, format = "%d/%m/%Y"),
         year = year(date)) %>% 
  select(year, pop)


```




```{r, load poverty}
# poverty https://fred.stlouisfed.org/series/PPAACA06075A156NCEN

poverty <- read_csv("data/poverty.csv") %>% 
  janitor::clean_names()

glimpse(poverty)

poverty <- poverty %>% 
  mutate(poverty_rate = as.double(poverty_rate),
         date = as.Date(date, format = "%d/%m/%Y"),
         year = year(date)) %>% 
  filter(year > 2002) %>% 
  select(year, poverty_rate)

```

```{r, load personal income}
# https://fred.stlouisfed.org/series/PCPI06075
income <- read_csv("data/personal_income.csv") %>% 
  janitor::clean_names()

glimpse(income)

income <- income %>% 
  mutate(date = as.Date(date, format = "%d/%m/%Y"),
         year = year(date)) %>% 
  select(year, personal_income)

```



```{r, join data}
# Join data
data_all <- left_join(data_all, unemployment, by = c("year", "month")) 

data_all <- left_join(data_all, cpi, by = c("year", "month"))

data_all <- left_join(data_all, pop, by = "year")

data_all <- left_join(data_all, poverty, by = "year")

data_all <- left_join(data_all, income, by = "year")
```


# Exploration (EDA)

```{r, plot crimes}
data_all %>% 
  group_by(year) %>% 
  summarise(count = sum(n)) %>% 
  ggplot(aes(x = year, y = count)) +
  geom_col()
  

#remove 2015?


```

```{r, plots}

# scatters, bar charts ??

```





```{r, geo data}
san_sf <- read_sf(here("data/San_Francisco/geo_export_2f04d6c0-ba9f-4bca-9353-c633452abad2.shp"))

glimpse(san_sf)

# what type of geometry does our shapefile have?
st_geometry(san_sf)


# https://www.houseofkinoko.com/sf-district-guide/
districts <- read_csv('data/neighbourhoods.csv') %>% 
  select(district, dist_name,neighbourhood) %>% 
  rename(name = neighbourhood)


san_sf_1 <- left_join(san_sf, districts, by = "name") 



```





```{r map chart}

ggplot(data = san_sf_1, fill = factor(dist_name)) +
  # draw polygons from San Francisco shapefile
  geom_sf(data = san_sf_1, fill = "darkblue", size = 0.125, colour = "#b2b2b277")


```



# Linear regression

```{r, model}

```


# Lasso?

```{r, lasso}

```

